# 🔧 PS2混合小车组装调试指南

## 📑 文档导航

1. [准备工作](#准备工作)
2. [组装步骤](#组装步骤)
3. [软件烧录](#软件烧录)
4. [功能调试](#功能调试)
5. [性能测试](#性能测试)
6. [常见问题](#常见问题)

---

## 🎯 准备工作 {#准备工作}

### 检查物料

参考 [物料清单BOM.md](./物料清单BOM.md) 确认所有元件齐全。

**核心检查项:**
```
□ STM32F103C8T6核心板/芯片 ×1
□ L298N驱动模块 ×2
□ LM2596降压模块 ×2
□ RT9013-33稳压器 ×1
□ JGB37-520电机 ×4
□ 18650电池 ×3 + 3S电池盒
□ PS2接收器 ×1
□ 各类线材、电容、电阻
```

### 工具准备

```
必备工具:
  ✓ T12电烙铁 (或936焊台)
  ✓ 热风枪 (焊接SMD芯片)
  ✓ 万用表 (电压/通断测试)
  ✓ 十字螺丝刀
  ✓ 尖嘴钳、斜口钳
  ✓ 剥线钳

可选工具:
  ○ 示波器 (信号调试)
  ○ 电动螺丝刀
  ○ 热熔胶枪
```

### 环境准备

```
工作台要求:
  - 防静电工作垫
  - 良好照明
  - 通风环境 (焊接烟雾)
  - 足够空间 (>60×40cm)
```

---

## 🔨 组装步骤 {#组装步骤}

### 阶段1: 电源系统组装 (60分钟)

#### 1.1 电池盒准备

```bash
步骤:
1. 安装3节18650电池到3S电池盒
   - 注意电池正负极方向 (+极朝上)
   - 确保每节电池电压 ≥3.7V
   
2. 测量电池组总电压
   万用表测量: 应为 11.1V-12.6V
   
3. 安装保护板 (如有)
   - 确认B-/B0/B1/B2/B+接线正确
   - 测试过流保护功能
```

#### 1.2 主电源线制作

**参考: [硬件连接指南.md](./硬件连接指南.md) 第7.1节**

```
材料: 16AWG硅胶线 (红黑各15cm)

步骤:
1. 剥线 (两端各剥5mm)
2. 镀锡 (预先挂锡)
3. 焊接XT60插头
   - 公头: 焊在电池盒
   - 母头: 焊在PCB/主线
4. 热缩管绝缘
5. 拉力测试 (>5kg不脱落)
```

#### 1.3 LM2596模块调压

```bash
LM2596 #1 (TX2供电):
  1. 输入端接11.1V电池
  2. 输出端接万用表
  3. 开机，调节电位器
  4. 输出电压调至 5.00V ±0.05V
  5. 用指甲油固定电位器
  
LM2596 #2 (STM32系统):
  1. 同上步骤
  2. 输出调至 5.00V ±0.05V
  3. 固定电位器
```

#### 1.4 RT9013焊接

**参考: [焊接教程](./焊接教程.md) 阶段3**

```
SOT-23封装焊接:
  Pin1 (VIN)  ← LM2596#2 输出5V
  Pin2 (GND)  ← 公共地
  Pin3 (VOUT) → STM32 VDD

旁路电容 (0603):
  输入: 10μF + 0.1μF
  输出: 10μF×2 + 1μF + 0.1μF×3
```

#### 1.5 电源系统测试

```bash
测试清单:
□ LM2596#1 输出 = 5.0V ±0.1V
□ LM2596#2 输出 = 5.0V ±0.1V
□ RT9013 输出 = 3.3V ±0.05V
□ 纹波 < 100mV (示波器)
□ 空载电流 < 50mA
□ 芯片不发热
```

---

### 阶段2: STM32最小系统 (90分钟)

#### 2.1 方案选择

**方案A: 使用成品核心板 (推荐新手)**

```
优点:
  ✓ 免焊接STM32芯片
  ✓ 最小系统已完成
  ✓ 价格便宜 (¥15)
  
接线:
  3.3V ← RT9013 VOUT
  GND  ← 公共地
  5V   ← 不接 (用3.3V)
  PA0-PA9, PB3-PB15 → 按需引出
```

**方案B: 自己焊接 (高级用户)**

参考 [焊接教程](./焊接教程.md) 阶段4，焊接:
- STM32F103C8T6芯片 (LQFP48)
- 8MHz晶振 + 20pF电容×2
- 复位电路
- BOOT配置电阻
- 去耦电容

#### 2.2 首次上电测试

```bash
1. 连接电源
   VDD  ← 3.3V
   GND  ← GND
   VDDA ← 3.3V
   
2. 测量供电
   万用表测量所有VDD引脚 = 3.3V
   
3. 检查晶振
   示波器测量OSC_IN: 应有8MHz方波
   
4. 测试IO
   万用表测量PA0: 应为高阻态(悬空)
```

#### 2.3 烧录Bootloader

```bash
工具: ST-Link V2 下载器

连接:
  ST-Link    STM32
  ─────────────────
  SWDIO  →   PA13
  SWCLK  →   PA14
  GND    →   GND
  3.3V   →   VDD (可选)

软件: STM32CubeProgrammer

步骤:
  1. 连接ST-Link到电脑
  2. 打开STM32CubeProgrammer
  3. 选择"ST-LINK"接口
  4. 点击"Connect"
  5. 读取芯片ID (应显示STM32F103C8)
  6. Erase Chip (全片擦除)
  7. 下载固件 (build/PS2_Hybird.hex)
  8. Verify 验证
  9. Reset 复位运行
```

---

### 阶段3: 电机驱动连接 (45分钟)

#### 3.1 L298N模块配置

**⚠️ 关键步骤: 移除跳线帽!**

```
L298N模块设置:
  1. 移除ENA跳线帽 (必须!)
  2. 移除ENB跳线帽 (必须!)
  3. 移除5V稳压跳线 (如有)
  4. 检查散热片安装牢固
```

#### 3.2 接线 (L298N#1 左侧)

```
电源:
  VCC  ← 11.1V电池 (16AWG红线)
  GND  ← 电池负极 (16AWG黑线)
  +5V  ← LM2596#2 输出 (20AWG)

控制信号 (来自STM32):
  ENA  ← PA8 (TIM1_CH1)
  IN1  ← PA0 + 1kΩ限流电阻
  IN2  ← PA1 + 1kΩ限流电阻

电机 (20AWG):
  OUT1 → 左前电机 M+ (红)
  OUT2 → 左前电机 M- (黑)
  OUT3 → 左后电机 M+ (红)
  OUT4 → 左后电机 M- (黑)
```

#### 3.3 接线 (L298N#2 右侧)

```
电源: 同L298N#1

控制信号:
  ENB  ← PA9 (TIM1_CH2)
  IN3  ← PA4 + 1kΩ
  IN4  ← PA5 + 1kΩ

电机:
  OUT1 → 右前电机 M+
  OUT2 → 右前电机 M-
  OUT3 → 右后电机 M+
  OUT4 → 右后电机 M-
```

#### 3.4 电机测试

```bash
手动测试 (不通电STM32):
  1. VCC接11.1V, GND接地
  2. +5V接5V
  3. ENA接5V (直接连)
  4. IN1接5V, IN2接GND
  5. 观察左前/左后电机转动
  
预期结果:
  ✓ 电机正转
  ✓ 转速正常
  ✓ 声音平稳
  
反向测试:
  IN1接GND, IN2接5V
  电机应反转
```

---

### 阶段4: 编码器连接 (30分钟)

#### 4.1 编码器线制作

**推荐: 使用4芯屏蔽线**

```
线长: 40cm
颜色标准:
  红色  → VCC (3.3V)
  黑色  → GND
  黄色  → A相
  绿色  → B相
  屏蔽层 → GND (单端接地)
```

#### 4.2 左侧编码器 (TIM2)

```
接线方案: 左前+左后编码器并联

      左前编码器      左后编码器
         ↓               ↓
    VCC─┬─────────────┬─VCC
    GND─┼─────────────┼─GND
    A相─┼─────────────┼─A相  → 220Ω → PA15
    B相─┴─────────────┴─B相  → 220Ω → PB3

保护电阻: 
  - 信号线串220Ω电阻
  - 防止ESD损伤STM32
```

#### 4.3 右侧编码器 (TIM3)

```
同左侧方案:
  A相 → 220Ω → PB4 (TIM3_CH1)
  B相 → 220Ω → PB5 (TIM3_CH2)
```

#### 4.4 编码器测试

```bash
工具: 串口助手

步骤:
  1. 上电STM32
  2. 手动转动左前电机
  3. 串口输出编码器计数变化
  4. 正转计数增加，反转计数减少
  
测试代码:
  while(1) {
    int32_t left = Encoder_GetLeftCount();
    int32_t right = Encoder_GetRightCount();
    printf("L:%d  R:%d\r\n", left, right);
    HAL_Delay(100);
  }
```

---

### 阶段5: PS2手柄配置 (20分钟)

#### 5.1 接收器连接

```
PS2接收器 → STM32

电源:
  VCC ← 5V (LM2596#2)
  GND ← 公共地

信号 (软件SPI):
  DI  ← PB12
  CMD ← PB13
  CS  ← PB14
  CLK ← PB15
  DO  → 不接
```

#### 5.2 手柄配对

```bash
配对步骤:
  1. 手柄安装2节7号电池
  2. 打开接收器电源
  3. 按住手柄START键
  4. 同时按MODE键3秒
  5. 红灯常亮表示配对成功
  
测试:
  推动左摇杆，观察串口输出:
  [PS2] LJ(127,127) Mode:0x73  ← 正常
  [PS2] LJ(255,127) Mode:0x73  ← 右推
  [PS2] LJ(127,0)   Mode:0x73  ← 上推
```

---

### 阶段6: TX2通信 (30分钟)

#### 6.1 检查TX2 UART电平

```bash
⚠️ 重要: TX2 UART可能是1.8V!

检查方法:
  1. TX2开机并启动系统
  2. 万用表测量J21 Pin8电压
  3. 如果是3.3V → 直接连接
  4. 如果是1.8V → 需加电平转换器
```

#### 6.2 直接连接 (3.3V电平)

```
TX2 J21    →    STM32
─────────────────────
Pin1/2(5V) →  独立供电
Pin8 (TX)  →  PB11 (RX)
Pin10(RX)  ←  PB10 (TX)
Pin14(GND) →  GND
```

#### 6.3 电平转换 (1.8V电平)

```
使用 TXS0108E 模块:

TXS0108E配置:
  VCCA ← 1.8V (TX2)
  VCCB ← 3.3V (STM32)
  GND  ← 公共地
  OE   ← VCCB (使能)
  
  A1 ← TX2 Pin8  (TX)
  B1 → STM32 PB11 (RX)
  
  A2 → TX2 Pin10 (RX)
  B2 ← STM32 PB10 (TX)
```

#### 6.4 通信测试

```bash
TX2端 (Python):
  import serial
  ser = serial.Serial('/dev/ttyTHS2', 115200)
  ser.write(b'CMD:MOVE,200,200\r\n')
  response = ser.readline()
  print(response)

STM32端 (串口输出):
  [UART] Received: CMD:MOVE,200,200
  [Motor] Left:200 Right:200
  [UART] Response: OK
```

---

## 💻 软件烧录 {#软件烧录}

### 编译固件

```bash
# Windows PowerShell
cd "C:\Users\Haoran laptop\Desktop\PS2_Hybird"

# 清理旧文件
make clean

# 编译项目
make

# 查看输出
ls build/

# 应生成:
#   PS2_Hybird.elf
#   PS2_Hybird.hex  ← 用于烧录
#   PS2_Hybird.bin
```

### 烧录方法

**方法1: ST-Link (推荐)**

```bash
使用 STM32CubeProgrammer:
  1. 连接ST-Link
  2. 选择 build/PS2_Hybird.hex
  3. 点击 "Download"
  4. 验证成功后点击 "Start"
```

**方法2: 串口烧录 (需Bootloader)**

```bash
使用 STM32 Flash Loader:
  1. BOOT0接3.3V, BOOT1接GND
  2. 复位STM32
  3. 打开Flash Loader
  4. 选择串口COM口
  5. 波特率115200
  6. 选择hex文件下载
  7. 完成后BOOT0接回GND
  8. 复位运行
```

---

## 🔍 功能调试 {#功能调试}

### 调试1: 串口输出

```bash
工具: 串口助手 (115200,8,N,1)

预期输出:
  =================================
    PS2 Hybrid Car Control System  
  =================================
  Mode: PS2
  Ready!
  
  [PS2] LJ(127,127) Mode:0x73
  [Motor] Speed: L=0 R=0
```

### 调试2: PS2控制

```bash
测试项目:
  1. 左摇杆上推 → 小车前进
  2. 左摇杆下拉 → 小车后退
  3. 左摇杆左推 → 小车左平移
  4. 左摇杆右推 → 小车右平移
  5. 按住JOYL  → 原地左转
  6. 按住JOYR  → 原地右转

检查:
  □ 方向正确
  □ 速度可调
  □ 响应及时
  □ 无抖动
```

### 调试3: 编码器反馈

```bash
测试:
  1. 前进1米，停止
  2. 读取编码器计数
  3. 计算实际距离
  
示例:
  左编码器: 1320脉冲
  右编码器: 1315脉冲
  
  轮径: 65mm
  编码器线数: 11×4 = 44 (四倍频)
  减速比: 30
  
  距离 = 1320/(44×30) × π×65mm
       ≈ 100cm ✓
```

### 调试4: TX2通信

```bash
Python脚本测试:
  cd /path/to/PS2_Hybird
  python3 car_controller.py
  
  输入命令:
  > CMD:FORWARD,300
  < OK
  
  > CMD:STOP
  < OK
  
检查:
  □ 命令识别正确
  □ 响应及时
  □ 无乱码
```

---

## 📊 性能测试 {#性能测试}

### 测试1: 速度测试

```bash
测试方法:
  1. 地面铺设5米卷尺
  2. PWM设置为最大(900)
  3. 计时通过5米所需时间
  
记录:
  PWM=900: 5米/3.2秒 = 1.56m/s
  PWM=600: 5米/4.8秒 = 1.04m/s
  PWM=300: 5米/9.5秒 = 0.53m/s
```

### 测试2: 续航测试

```bash
条件:
  - 满电3S电池 (12.6V)
  - 持续前进PWM=500
  - 平坦地面
  
结果:
  运行时间: 约35分钟
  截止电压: 9.8V
  
建议:
  - 添加电压监测
  - <10V时停止运行
  - 及时充电
```

### 测试3: 转向测试

```bash
原地360°旋转测试:
  1. 地面标记起始位置
  2. 调用 Car_TurnLeft(400)
  3. 记录完成360°时间
  
结果:
  左转360°: 2.8秒
  右转360°: 2.9秒
  
精度:
  误差: ±5° (可接受)
```

### 测试4: 负载测试

```bash
承重测试:
  1. 小车上放置砝码
  2. 测试最大爬坡角度
  
结果:
  空载: 最大25°
  500g: 最大20°
  1000g: 最大15°
  
建议最大负载: 1kg
```

---

## ❓ 常见问题 {#常见问题}

### Q1: STM32无串口输出

```
可能原因:
  1. 供电不正常
  2. 晶振未起振
  3. BOOT0配置错误
  4. 程序未烧录成功

排查:
  ✓ 测量VDD = 3.3V
  ✓ 示波器看晶振波形
  ✓ 检查BOOT0接地
  ✓ 重新烧录程序
  ✓ 尝试ST-Link下载调试
```

### Q2: 电机不转

```
可能原因:
  1. L298N跳线帽未移除
  2. PWM信号无输出
  3. 电机线接反
  4. 供电电压不足

排查:
  ✓ 检查并移除跳线帽
  ✓ 示波器测PA8/PA9 PWM
  ✓ 对调电机M+/M-
  ✓ 测VCC = 11.1V
  ✓ 手动接线测电机
```

### Q3: PS2手柄无响应

```
可能原因:
  1. 接收器未供电
  2. 引脚连接错误
  3. 手柄未配对
  4. 手柄没电

排查:
  ✓ 测接收器VCC = 5V
  ✓ 核对DI/CMD/CS/CLK
  ✓ 重新配对手柄
  ✓ 更换手柄电池
  ✓ 串口看Mode值
```

### Q4: TX2通信失败

```
可能原因:
  1. 波特率不匹配
  2. TX/RX接反
  3. GND未共地
  4. 电平不匹配

排查:
  ✓ 确认都是115200
  ✓ TX接RX, RX接TX
  ✓ 万用表测GND通路
  ✓ 测量UART电平
  ✓ 添加电平转换
```

### Q5: 编码器计数不准

```
可能原因:
  1. 信号干扰
  2. 线材过长
  3. 配置错误
  4. 机械抖动

排查:
  ✓ 使用屏蔽线
  ✓ 缩短线长<50cm
  ✓ 检查TIM配置
  ✓ 增加滤波参数
  ✓ 示波器看波形
```

---

## 📚 相关文档

- [硬件连接指南.md](./硬件连接指南.md) - 详细接线说明
- [焊接教程.md](./焊接教程.md) - 焊接技巧
- [物料清单BOM.md](./物料清单BOM.md) - 采购清单
- [上位机使用说明.md](./上位机使用说明.md) - TX2控制

---

## ✅ 完成检查清单

```
□ 电源系统测试通过
□ STM32正常运行
□ 串口输出正常
□ PS2手柄控制正常
□ 四个电机运转正常
□ 编码器计数正确
□ TX2通信正常
□ 性能测试达标
□ 外观整洁美观
□ 线束固定牢固
```

**恭喜完成组装! 🎉**

---

**文档版本:** v1.0  
**更新日期:** 2025-01-29  
**预计耗时:** 4-6小时
