# PS2混合小车 - 快速开始指南

## 🚀 5分钟快速启动

### 步骤1：准备硬件

**需要的硬件**：
- ✅ STM32F103C8T6开发板（蓝色药丸）
- ✅ 4个JGB37-520带编码器电机
- ✅ 2个L298N电机驱动模块
- ✅ PS2无线手柄和接收器
- ✅ 7.4V锂电池（推荐2S）
- ✅ USB转TTL模块（用于串口通信）
- ✅ ST-Link或J-Link下载器
- ✅ 杜邦线若干

### 步骤2：连接硬件

#### 电机驱动连接（L298N）

**第一个L298N（左侧电机）**：
```
STM32       L298N       电源/电机
PA0    →    IN1
PA1    →    IN2
PA8    →    ENA
GND    →    GND
                OUT1 →  左前电机+
                OUT2 →  左前电机-
                OUT3 →  左后电机+  
                OUT4 →  左后电机-
                +12V →  电池+
                GND  →  电池-
```

**第二个L298N（右侧电机）**：
```
STM32       L298N       电源/电机
PA4    →    IN3
PA5    →    IN4
PA9    →    ENB
GND    →    GND
                OUT1 →  右前电机+
                OUT2 →  右前电机-
                OUT3 →  右后电机+
                OUT4 →  右后电机-
                +12V →  电池+
                GND  →  电池-
```

**注意**：
- L298N的ENA和ENB跳帽需要拔掉，改用PWM控制
- 确保电池负极与STM32的GND共地

#### 编码器连接

```
左侧编码器：
    A相 → PA15
    B相 → PB3
    VCC → 5V
    GND → GND

右侧编码器：
    A相 → PB4
    B相 → PB5
    VCC → 5V
    GND → GND
```

#### PS2手柄接收器连接

```
PS2接收器     STM32
DI      →     PB12
CMD     →     PB13
CS      →     PB14
CLK     →     PB15
VCC     →     3.3V
GND     →     GND
```

#### 串口连接（USB转TTL）

```
USB转TTL      STM32
TX      →     PB11 (RX)
RX      →     PB10 (TX)
GND     →     GND
```

**注意**：不要连接VCC，STM32由ST-Link或电池供电

### 步骤3：下载程序

1. **使用STM32CubeIDE**：
   ```
   - 打开项目
   - 点击 Build (Ctrl+B)
   - 点击 Run (F11)
   ```

2. **使用Keil MDK**：
   ```
   - 打开 MDK-ARM/PS2_Hybird.uvprojx
   - 点击 Build (F7)
   - 点击 Download (F8)
   ```

3. **使用命令行（Make）**：
   ```bash
   make
   make flash
   ```

### 步骤4：测试PS2手柄

1. 给系统上电
2. 打开PS2手柄电源（接收器LED应该亮起）
3. 拨动左摇杆：
   - **前后推**：小车前进/后退
   - **左右推**：小车原地左转/右转

**指示灯说明**：
- PS2接收器LED常亮：手柄已连接
- PS2接收器LED闪烁：手柄未连接

### 步骤5：测试串口通信（可选）

1. **打开串口调试工具**：
   - 波特率：115200
   - 数据位：8
   - 停止位：1
   - 校验位：无

2. **切换到上位机模式**：
   ```
   CMD:MODE,1
   ```
   返回：`OK: Mode set to 1 (UART)`

3. **测试移动**：
   ```
   CMD:MOVE,F,500
   ```
   小车应该开始前进

4. **停止**：
   ```
   CMD:STOP
   ```

## 📝 常见问题快速排查

### 问题1：小车不动

**检查清单**：
- [ ] 电池电量充足？（用万用表测量应≥7V）
- [ ] L298N的跳帽是否拔掉？
- [ ] 电机线是否插好？
- [ ] STM32是否成功下载程序？（LED是否闪烁）
- [ ] PA8/PA9是否有PWM输出？（用示波器或万用表测量）

**快速测试**：
```c
// 在main.c的while循环中添加测试代码
Car_Forward(500);
HAL_Delay(2000);
Car_Stop();
HAL_Delay(2000);
```

### 问题2：PS2手柄无响应

**检查清单**：
- [ ] 手柄电池是否有电？
- [ ] 接收器LED是否亮？
- [ ] 接线是否正确？
- [ ] 手柄是否已对码？（参考手柄说明书）

**快速测试**：
通过串口打印手柄数据，查看mode值：
- 0x73或0x41：手柄正常
- 0xFF或0x00：手柄未连接

### 问题3：小车只能转不能走（或只能走不能转）

**可能原因**：
- 电机接线错误
- IN1-IN4的GPIO配置错误
- PWM通道分配错误

**解决方法**：
1. 检查motor_control.h中的宏定义是否正确
2. 测试每个电机单独运行
3. 检查L298N接线

### 问题4：串口无法通信

**检查清单**：
- [ ] 波特率是否为115200？
- [ ] TX/RX是否接反？
- [ ] USB转TTL驱动是否安装？
- [ ] 串口号是否正确？（设备管理器查看）
- [ ] 是否切换到上位机模式？（CMD:MODE,1）

## 🎯 进阶功能

### 使用Python控制程序

1. **安装Python（如果还没有）**：
   - 下载：https://www.python.org/downloads/
   - 安装时勾选"Add Python to PATH"

2. **安装依赖**：
   ```bash
   pip install pyserial
   ```

3. **运行控制程序**：
   ```bash
   python car_controller.py
   ```

4. **选择功能**：
   - 手动控制：使用WASD键控制
   - 自动寻路：选择预设路径（正方形、三角形等）

### 自动寻路示例

```python
from car_controller import CarController, AutoNavigator

# 创建控制器
car = CarController('COM3')  # 根据实际串口修改

# 创建导航器
nav = AutoNavigator(car)

# 走一个正方形
square = nav.square_path(side_time=2.0, turn_time=0.8, speed=500)
nav.execute_path(square)

# 关闭
car.close()
```

## 📚 学习资源

### 文档位置
- **README.md**：项目总览和完整文档
- **上位机使用说明.md**：详细的串口协议和编程接口
- **CubeMX配置说明.md**：硬件配置详解
- **car_controller.py**：Python控制程序源码

### 核心代码位置
- **PS2手柄驱动**：`Core/Src/ax_ps2.c`
- **电机控制**：`Core/Src/motor_control.c`
- **串口协议**：`Core/Src/usart.c`
- **主程序**：`Core/Src/main.c`

### 修改建议

**调整速度**：
在 `motor_control.h` 中修改：
```c
#define MAX_PWM 900    // 改小降低最大速度
#define MIN_PWM 150    // 改小降低最小速度
```

**调整摇杆灵敏度**：
在 `motor_control.h` 中修改：
```c
#define DEAD_ZONE 15   // 改大减小灵敏度，改小增加灵敏度
```

**调整转向角度**：
需要实测，在自动寻路中修改转向时间：
```python
# 90度转向需要的时间（秒）
turn_time = 0.8  # 根据实测调整
```

## 🔧 调试技巧

### 1. 使用串口打印调试信息

```c
printf("Left PWM: %d, Right PWM: %d\r\n", left_pwm, right_pwm);
```

### 2. 查看编码器计数

```
CMD:STATUS
```
返回：`STATUS: LeftEnc=12345, RightEnc=12340, Mode=1`

### 3. 单独测试每个电机

```c
// 测试左前电机
HAL_GPIO_WritePin(GPIOA, GPIO_PIN_0, GPIO_PIN_SET);
HAL_GPIO_WritePin(GPIOA, GPIO_PIN_1, GPIO_PIN_RESET);
__HAL_TIM_SET_COMPARE(&htim1, TIM_CHANNEL_1, 500);
```

## ⚡ 性能优化

### 1. 编码器PID速度闭环

可以添加PID控制实现恒速运行，避免电池电压降低导致速度变化。

### 2. 差速转向

修改 `PS2_Control_Car()` 函数，实现前进时的差速转向：
```c
// 前进时可以转向
left_pwm = forward_speed + turn_speed;
right_pwm = forward_speed - turn_speed;
```

### 3. 速度平滑

已经实现了一阶低通滤波，可以调整滤波系数：
```c
// 在 Speed_Filter_Update() 中
*left_filtered = (int16_t)(0.3 * left_target + 0.7 * (*left_filtered));
// 0.3越大，响应越快，但越不平滑
```

## 🎉 成功！

现在你的PS2混合小车应该已经正常工作了！

**下一步可以尝试**：
- [ ] 添加超声波避障
- [ ] 添加陀螺仪实现精确转向
- [ ] 实现路径规划算法
- [ ] 添加摄像头进行视觉识别
- [ ] 连接ROS机器人操作系统

**祝你玩得开心！** 🚗💨

---

**问题反馈**：如遇到问题，请查看完整文档或提issue。  
**版本**：v1.0  
**日期**：2025-10-27
