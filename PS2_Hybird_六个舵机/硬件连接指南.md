# 🔌 PS2混合小车硬件连接完整指南

## 📋 项目概述

本项目为基于STM32F103C8T6的四驱小车控制系统，搭载NVIDIA Jetson TX2作为上位机，支持PS2手柄与串口双模式控制。

### 核心配置
- **主控芯片**: STM32F103C8T6 (ARM Cortex-M3, 72MHz)
- **上位机**: NVIDIA Jetson TX2
- **电源**: 3S 18650锂电池组 (11.1V, 2500mAh)
- **电机**: 4×JGB37-520减速电机（带编码器）
- **驱动**: 2×L298N双路H桥驱动模块
- **驱动方式**: 每个L298N控制2个同侧电机（L298N#1:左前+左后，L298N#2:右前+右后）

---

## ⚡ 供电系统设计

### 整体架构

```
3S 18650电池组 (11.1V, 2500mAh)
    │
    ├─── 30A保险丝 ─── SS54防反接二极管 ─── 主开关
    │
    ├────────────────┬─────────────────┬──────────────┐
    │                │                 │              │
    ▼                ▼                 ▼              ▼
[LM2596-5V/4A]  [LM2596-5V/3A]   [L298N#1]      [L298N#2]
 (TX2专用)       (STM32系统)     (VCC直供)      (VCC直供)
    │                │
    ▼                ▼
  TX2 5V      [RT9013-3.3V/500mA]
                     │
                     ▼
                STM32核心供电
```

### 1. 主电源分配

#### 电池组规格
- **型号**: INR18650-25P (EVE亿纬锂能)
- **配置**: 3S串联
- **电压**: 11.1V标称，12.6V满电，8.25V截止
- **容量**: 2500mAh
- **最大放电**: 30A (12C)

#### 保护电路
```
电池正极 → 30A自恢复保险丝 → SS54肖特基二极管 → 主开关 → 各模块
电池负极 → 系统公共地
```

**关键元件:**
- 30A保险丝座: 过流保护
- SS54二极管: 5A/40V，防止电池反接
- 30A主开关: 总电源控制

---

### 2. TX2供电模块 (5V/4A)

#### LM2596HV降压模块配置

```
输入: 11.1V (8.25V~12.6V)
输出: 5V / 4A

连接:
    IN+  ← 主开关输出 (16AWG)
    IN-  ← 电池负极
    OUT+ → TX2 J21 Pin1/2 (5V供电)
    OUT- → TX2 J21 Pin14 (GND)

输出滤波电容:
    220μF/16V 低ESR × 2 (并联)
    + 100μF/10V × 1
    + 0.1μF/50V × 3
```

**调压步骤:**
1. 输入11.1V电压
2. 万用表测量输出端
3. 调节电位器至5.00V±0.05V
4. 用指甲油固定电位器

---

### 3. STM32系统供电

#### 3.1 LM2596降压模块 (5V/3A)

```
输入: 11.1V
输出: 5.0V / 3A

用途:
    ├─ RT9013稳压器输入
    ├─ PS2接收器 (5V/50mA)
    ├─ L298N#1 逻辑电源 (5V/50mA)
    └─ L298N#2 逻辑电源 (5V/50mA)

输出电容:
    470μF/10V × 1
    + 100μF/10V × 2
    + 0.1μF/50V × 4
```

#### 3.2 RT9013-33稳压器 (3.3V/500mA)

**推荐使用RT9013而非AMS1117的原因:**
- 压差更小: 200mV vs 1V
- 发热更少: 适合5V→3.3V
- 效率更高: >90%

**SOT-23封装引脚连接:**
```
    Pin1 (VIN)  ← LM2596输出5V
    Pin2 (GND)  ← 系统公共地
    Pin3 (VOUT) → STM32所有VDD引脚 (3.3V)

输入端电容 (0603):
    10μF X5R + 0.1μF (距离<5mm)
    
输出端电容 (0603):
    10μF × 2 (并联)
    + 1μF × 1
    + 0.1μF × 3 (分布到各VDD引脚)
```

---

## 🚗 电机驱动系统

### L298N模块配置

**重要说明**：
- L298N#1控制左前电机+左后电机（两电机并联）
- L298N#2控制右前电机+右后电机（两电机并联）
- 每个L298N的OUT1-OUT4同时驱动2个电机

#### L298N#1 (左侧双电机)

```
电源连接:
    VCC  ← 11.1V电池 (16AWG硅胶线)
    GND  ← 电池负极
    +5V  ← LM2596#2输出 (逻辑电源)

控制信号 (来自STM32):
    ENA  ← PA8 (TIM1_CH1, 1kHz PWM)
    IN1  ← PA0 (方向控制1)
    IN2  ← PA1 (方向控制2)

电机输出 (并联连接):
    OUT1 → 左前电机 M+ (红线)
    OUT2 → 左前电机 M- (黑线)
    OUT3 → 左后电机 M+ (红线)
    OUT4 → 左后电机 M- (黑线)

注意:
    - OUT1和OUT3并联连接到两个电机的M+
    - OUT2和OUT4并联连接到两个电机的M-
    - 两电机同步前进/后退
```

#### L298N#2 (右侧双电机)

```
电源连接:
    VCC  ← 11.1V电池
    GND  ← 电池负极
    +5V  ← LM2596#2输出

控制信号:
    ENB  ← PA9 (TIM1_CH2, 1kHz PWM)
    IN3  ← PA4 (方向控制1)
    IN4  ← PA5 (方向控制2)

电机输出 (并联连接):
    OUT1 → 右前电机 M+ (红线)
    OUT2 → 右前电机 M- (黑线)
    OUT3 → 右后电机 M+ (红线)
    OUT4 → 右后电机 M- (黑线)

注意:
    - OUT1和OUT3并联连接到两个电机的M+
    - OUT2和OUT4并联连接到两个电机的M-
    - 两电机同步前进/后退
```

**⚠️ 重要设置:**
- **移除ENA/ENB跳线帽** (必须！)
- **移除板载5V稳压跳线帽**
- VCC端只接11.1V电池，不接5V
- 建议在IN引脚串联1kΩ限流电阻

---

## 🎮 PS2手柄接收器

### 接口连接

```
PS2接收器 → STM32F103C8T6

电源:
    VCC  ← 5V (来自LM2596#2)
    GND  ← 系统公共地

信号 (GPIO模拟SPI):
    DI   ← PB12 (数据输入)
    DO   → 悬空或接GND
    CS   ← PB14 (片选)
    CLK  ← PB15 (时钟)
    CMD  ← PB13 (命令)
```

**通信协议:** 
- 软件模拟SPI通信
- 轮询周期: 20ms
- 数据格式: 9字节 (见ax_ps2.h)

---

## 🔄 编码器接口

**重要原理**：
- 同侧的两个电机由同一个L298N驱动，方向和速度完全一致
- 因此编码器可以将同侧两个电机的信号并联
- 并联后的编码器计数值为两电机的综合反馈

### 左侧编码器 (TIM2)

```
接线方式: 左前+左后电机编码器并联

具体连接:
    左前电机ENC_A ─┐
                      ├─ 220Ω保护电阻 → PA15 (TIM2_CH1)
    左后电机ENC_A ─┘
    
    左前电机ENC_B ─┐
                      ├─ 220Ω保护电阻 → PB3  (TIM2_CH2)
    左后电机ENC_B ─┘
    
    所有ENC_VCC    ── 3.3V
    所有ENC_GND    ── 系统公共地
```

### 右侧编码器 (TIM3)

```
接线方式: 右前+右后电机编码器并联

具体连接:
    右前电机ENC_A ─┐
                      ├─ 220Ω保护电阻 → PB4 (TIM3_CH1)
    右后电机ENC_A ─┘
    
    右前电机ENC_B ─┐
                      ├─ 220Ω保护电阻 → PB5 (TIM3_CH2)
    右后电机ENC_B ─┘
    
    所有ENC_VCC    ── 3.3V
    所有ENC_GND    ── 系统公共地
```

**配置参数:**
- 编码器模式: TI12 (四倍频)
- 计数范围: 0-65535 (16位)
- 内部上拉: 已启用
- 滤波: IC1 Filter=6

**注意事项:**
1. 同侧电机编码器A相并联、B相并联
2. 并联节点到STM32之间加220Ω保护电阻
3. 使用屏蔽双绞线，屏蔽层接地
4. 如编码器是5V输出，需加分压电阻（3.3K和6.8K分压）
5. 编码器并联后计数速度约为单个电机的2倍

---

## 📡 TX2与STM32串口通信

### J21扩展口连接

```
TX2 J21引脚 → 功能 → STM32引脚
─────────────────────────────────
Pin1/2 (5V)    电源   → 独立LM2596供电
Pin14  (GND)   地线   → 系统公共地
Pin8   (TX)    发送   → PB11 (USART3_RX)
Pin10  (RX)    接收   ← PB10 (USART3_TX)
Pin9   (GND)   地线   → GND
```

### 串口配置参数

```
波特率: 115200
数据位: 8
停止位: 1
校验位: None
流控:   None
```

### 电平匹配检查

**TX2 UART电平可能是1.8V，需确认:**

1. 用万用表测量TX2 J21 Pin8电压
2. 如果是3.3V → 可直接连接
3. 如果是1.8V → 需要电平转换

**电平转换方案 (如需要):**

```
使用 TXS0108E 双向电平转换器

连接:
    VCCA (1.8V侧) ← TX2的1.8V电源
    VCCB (3.3V侧) ← STM32的3.3V
    GND           ← 公共地
    
    A1 ← TX2 Pin8  (TX, 1.8V)
    B1 → PB11      (RX, 3.3V)
    
    A2 → TX2 Pin10 (RX, 1.8V)
    B2 ← PB10      (TX, 3.3V)
```

---

## 🔌 STM32最小系统

### 电源引脚

```
3.3V供电 (来自RT9013):
    VDD  (Pin1, 9, 24, 48) ← 3.3V
    VDDA (Pin9)            ← 3.3V (模拟电源)

地线:
    VSS  (Pin8, 23, 35, 47) ← GND
    VSSA (Pin8)             ← GND (模拟地)

去耦电容 (0603, 每个VDD附近):
    0.1μF × 4 (距离<5mm)
    10μF  × 1 (VDDA专用)
```

### 复位电路

```
NRST (Pin7):
    ├─ 10kΩ上拉到3.3V
    ├─ 0.1μF电容到GND
    └─ 复位按键到GND
```

### 启动配置

```
BOOT0 (Pin44) ── 10kΩ下拉 ── GND  (Flash启动)
BOOT1 (Pin20) ── 10kΩ下拉 ── GND
```

### 晶振电路

```
8MHz无源晶振:
    OSC_IN  (PD0, Pin5)  ← 晶振Pin1 + 20pF到GND
    OSC_OUT (PD1, Pin6)  ← 晶振Pin2 + 20pF到GND
```

---

## 📊 完整引脚分配表

| 功能分类 | STM32引脚 | 连接目标 | 说明 |
|---------|----------|---------|------|
| **电机控制** ||||
| 左侧电机方向1 | PA0 | L298N#1 IN1 | GPIO推挽输出 |
| 左侧电机方向2 | PA1 | L298N#1 IN2 | GPIO推挽输出 |
| 右侧电机方向1 | PA4 | L298N#2 IN3 | GPIO推挽输出 |
| 右侧电机方向2 | PA5 | L298N#2 IN4 | GPIO推挽输出 |
| 左侧电机PWM | PA8 | L298N#1 ENA | TIM1_CH1, 1kHz |
| 右侧电机PWM | PA9 | L298N#2 ENB | TIM1_CH2, 1kHz |
| **编码器** ||||
| 左侧编码器A | PA15 | 左前+左后 ENC_A并联 | TIM2_CH1 编码器模式 |
| 左侧编码器B | PB3 | 左前+左后 ENC_B并联 | TIM2_CH2 编码器模式 |
| 右侧编码器A | PB4 | 右前+右后 ENC_A并联 | TIM3_CH1 编码器模式 |
| 右侧编码器B | PB5 | 右前+右后 ENC_B并联 | TIM3_CH2 编码器模式 |
| **串口通信** ||||
| USART3_TX | PB10 | TX2 J21 Pin10 | 115200波特率 |
| USART3_RX | PB11 | TX2 J21 Pin8 | 中断接收 |
| **PS2手柄** ||||
| PS2数据 | PB12 | PS2接收器DI | GPIO输入 |
| PS2命令 | PB13 | PS2接收器CMD | GPIO输出 |
| PS2片选 | PB14 | PS2接收器CS | GPIO输出 |
| PS2时钟 | PB15 | PS2接收器CLK | GPIO输出 |
| **系统** ||||
| 晶振输入 | PD0 | 8MHz晶振 | HSE |
| 晶振输出 | PD1 | 8MHz晶振 | HSE |
| 复位 | NRST | 复位电路 | - |
| 启动模式0 | BOOT0 | GND (下拉) | Flash启动 |

---

## 🛠️ 接线规范

### 线材规格要求

| 用途 | 线径 | 颜色标准 | 长度建议 |
|------|------|---------|---------|
| 电池主线 | 16AWG (1.5mm²) | 红/黑 | 15cm |
| 5V电源 | 20AWG (0.5mm²) | 红/黑 | 20cm |
| 3.3V电源 | 22AWG | 红/黑 | 10cm |
| PWM信号 | 26AWG | 黄/橙 | 30cm |
| 编码器 | 屏蔽双绞线 | - | 40cm |
| 电机线 | 20AWG | 红/黑 | 30cm |

### 共地要求

**所有模块GND必须连接 (星形拓扑):**

```
          系统公共地汇集点
                 │
    ┌────────────┼────────────┐
    │            │            │
    ▼            ▼            ▼
电池GND    L298N GND    LM2596 GND
    │            │            │
    ▼            ▼            ▼
STM32 GND   TX2 GND     PS2 GND
```

**地线阻抗:** 任意两点间 < 0.5Ω

---

## 🔋 功耗估算与续航

### 峰值功耗分析

```
模块            电压    电流    功率
────────────────────────────────────
TX2满载         5V      3.0A    15W
STM32系统       5V      0.3A    1.5W
PS2接收器       5V      0.05A   0.25W
四电机峰值      11.1V   4.0A    44W
L298N损耗       -       -       8W
────────────────────────────────────
总计峰值                        ~69W
```

### 电池续航时间

```
电池容量: 2500mAh × 11.1V = 27.75Wh

续航时间 (效率按80%计算):
  满负载70W:  27.75Wh ÷ 70W × 0.8 = 19分钟
  中等40W:    27.75Wh ÷ 40W × 0.8 = 33分钟
  轻载20W:    27.75Wh ÷ 20W × 0.8 = 66分钟
```

**建议:**
- 准备2-3组电池轮换
- 添加电池电压监测 (ADC)
- 低压报警阈值: 9.6V (3.2V/节)

---

## ⚠️ 安全注意事项

### 上电前检查清单

- [ ] 电池电压在11.1V-12.6V范围
- [ ] 主电源线无短路 (万用表电阻>10kΩ)
- [ ] 3.3V轨无短路
- [ ] 5V轨无短路
- [ ] L298N跳线帽已移除
- [ ] 所有电解电容极性正确
- [ ] SS54二极管方向正确
- [ ] 所有IC芯片方向正确

### 首次上电步骤

1. **断开所有负载**，仅测试电源
2. 接入电池，打开主开关
3. 测量LM2596#1输出 = 5.0V±0.1V
4. 测量LM2596#2输出 = 5.0V±0.1V
5. 测量RT9013输出 = 3.3V±0.05V
6. 测量STM32各VDD引脚 = 3.3V
7. 触摸IC芯片，确认无异常发热
8. 逐步连接负载，每步测试

### 故障保护

```
保护措施            触发条件        动作
──────────────────────────────────────
30A保险丝           过流>30A        断开
SS54二极管          反接            阻断
低压报警            <9.6V           蜂鸣提示
过温保护            >85℃           软件限流
```

---

## 📝 测试验证流程

### 阶段1: 电源系统测试

```bash
1. 电源输出测试
   □ LM2596#1 输出 5.0V
   □ LM2596#2 输出 5.0V  
   □ RT9013 输出 3.3V
   □ 纹波 <100mV (示波器)

2. 负载测试
   □ TX2正常启动
   □ STM32工作正常
   □ 静态电流 <200mA
```

### 阶段2: STM32功能测试

```bash
1. 基础测试
   □ 烧录Bootloader成功
   □ LED闪烁程序运行
   □ 串口输出"Hello"
   
2. 外设测试
   □ TIM1 PWM输出正常 (示波器)
   □ TIM2/TIM3 编码器计数
   □ USART3 收发数据
   □ GPIO控制L298N
```

### 阶段3: 电机驱动测试

```bash
1. 单电机测试
   □ 前进/后退方向正确
   □ PWM调速线性
   □ 编码器计数正确
   
2. 四电机协同
   □ 前进/后退同步
   □ 左转/右转平稳
   □ 速度控制精确
```

### 阶段4: 通信测试

```bash
1. PS2手柄
   □ 手柄成功配对
   □ 摇杆数据读取
   □ 按键响应正常
   
2. TX2串口
   □ 发送指令到STM32
   □ STM32回传数据
   □ 波特率115200稳定
```

---

## 🆘 常见问题排查

### 问题1: STM32不工作

**症状:** 无串口输出，LED不亮

**排查步骤:**
1. 测量VDD引脚电压 = 3.3V?
2. 测量晶振是否起振 (示波器)
3. 检查BOOT0是否接GND
4. 检查NRST是否上拉
5. 重新烧录程序

### 问题2: 电机不转

**症状:** 控制信号正常，电机无响应

**排查步骤:**
1. 检查L298N跳线帽是否移除
2. 测量ENA/ENB引脚PWM信号
3. 测量L298N VCC = 11.1V?
4. 测量L298N逻辑5V = 5.0V?
5. 检查电机接线极性
6. 手动短接IN1/IN2测试电机

### 问题3: PS2手柄连接失败

**症状:** 串口输出Mode=0x00

**排查步骤:**
1. PS2接收器5V供电正常?
2. 检查引脚连接 (DI/CMD/CS/CLK)
3. 手柄是否配对 (红灯常亮)
4. 更换手柄电池
5. 检查代码延时参数

### 问题4: 编码器计数异常

**症状:** 计数不变或乱跳

**排查步骤:**
1. 编码器供电3.3V稳定?
2. 信号线是否使用屏蔽线
3. 检查TIM2/TIM3配置
4. 示波器观察A/B相波形
5. 测试电机转动方向

### 问题5: TX2通信失败

**症状:** 串口无数据交互

**排查步骤:**
1. 确认波特率115200
2. TX/RX是否交叉连接
3. GND是否共地
4. 电平是否匹配 (3.3V or 1.8V)
5. 用串口助手单独测试

---

## 📚 相关文档

- [焊接教程](./焊接教程.md) - 详细的硬件焊接指南
- [CubeMX配置说明.md](./CubeMX配置说明.md) - STM32外设配置
- [上位机使用说明.md](./上位机使用说明.md) - TX2控制接口
- [快速开始指南.md](./快速开始指南.md) - 快速入门

---

## 📞 技术支持

如有问题，请检查：
1. 所有连接是否按本文档执行
2. 电压是否在规定范围
3. 焊接质量是否合格
4. 代码版本是否最新

---

**文档版本:** v2.0  
**更新日期:** 2025-10-29  
**适用硬件:** STM32F103C8T6 + TX2 + 3S电池 + 4电机2电驱配置
