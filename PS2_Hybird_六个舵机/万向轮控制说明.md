# PS2万向轮小车控制说明

## 📋 硬件配置

### 电机驱动配置
- **L298N #1**（左侧驱动）
  - OUT1/OUT2 → 左前轮电机
  - OUT3/OUT4 → 左后轮电机
  - IN1 → PA0
  - IN2 → PA1
  - ENA → PA8 (TIM1_CH1 PWM)

- **L298N #2**（右侧驱动）
  - OUT1/OUT2 → 右前轮电机
  - OUT3/OUT4 → 右后轮电机
  - IN3 → PA4
  - IN4 → PA5
  - ENB → PA9 (TIM1_CH2 PWM)

### 万向轮配置
- 4个万向轮（麦克纳姆轮或全向轮）
- 支持全方位移动（前后左右+旋转）

## 🎮 PS2手柄控制说明

### 控制逻辑（优先级从高到低）

#### 1. 按键原地旋转（最高优先级）
- **按住JOYL（左摇杆按键）**：小车原地左转
  - 固定速度：400
  - 左侧电机后退，右侧电机前进
  
- **按住JOYR（右摇杆按键）**：小车原地右转
  - 固定速度：400
  - 左侧电机前进，右侧电机后退

#### 2. 左摇杆控制平移
当没有按下JOYL/JOYR时，左摇杆控制小车移动：

**前后移动**：
- 向上推（ljoy_ud < 112）：小车前进
- 向下推（ljoy_ud > 142）：小车后退
- 速度与摇杆偏离程度成正比

**左右平移**：
- 向左推（ljoy_lr < 112）：小车左平移
  - 左侧电机后退，右侧电机前进
- 向右推（ljoy_lr > 142）：小车右平移
  - 左侧电机前进，右侧电机后退

**方向判断**：
- 如果前后摇杆幅度 > 左右摇杆幅度：执行前后移动
- 如果左右摇杆幅度 > 前后摇杆幅度：执行左右平移

## 🔧 代码实现

### 新增函数

```c
// 万向轮平移功能
void Car_Move_Left(int16_t speed);   // 左平移
void Car_Move_Right(int16_t speed);  // 右平移

// PS2控制（新增btn1参数）
void PS2_Control_Car(uint8_t ljoy_lr, uint8_t ljoy_ud, uint8_t btn1);
```

### 按键位定义

```c
#define BTN_JOYR  (1<<1)  // Bit1 - 右摇杆按键
#define BTN_JOYL  (1<<2)  // Bit2 - 左摇杆按键
```

在PS2数据结构中：
- `ps2_data.btn1`的Bit1 = JOYR状态（0=未按下，1=按下）
- `ps2_data.btn1`的Bit2 = JOYL状态（0=未按下，1=按下）

## 📊 运动模式对照表

| 摇杆/按键状态 | 小车动作 | 左电机 | 右电机 |
|--------------|---------|--------|--------|
| 按住JOYL | 原地左转 | 后退 | 前进 |
| 按住JOYR | 原地右转 | 前进 | 后退 |
| 左摇杆↑ | 前进 | 前进 | 前进 |
| 左摇杆↓ | 后退 | 后退 | 后退 |
| 左摇杆← | 左平移 | 后退 | 前进 |
| 左摇杆→ | 右平移 | 前进 | 后退 |
| 摇杆回中 | 停止 | 停止 | 停止 |

## ⚙️ 参数说明

### 速度参数
```c
#define MAX_PWM 900     // 最大PWM占空比
#define MIN_PWM 150     // 最小PWM占空比（死区阈值）
#define DEAD_ZONE 15    // 摇杆死区（127±15）
```

### 旋转速度
- 按键旋转固定速度：400
- 可在代码中修改：
  ```c
  if(btn1 & BTN_JOYL)
  {
      Car_TurnLeft(400);  // 修改这个值调整旋转速度
  }
  ```

## 🎯 使用示例

### 前后左右移动
1. 向前走：左摇杆向上推
2. 向后走：左摇杆向下拉
3. 左平移：左摇杆向左推
4. 右平移：左摇杆向右推

### 原地旋转
1. 原地左转：按住左摇杆（JOYL键）
2. 原地右转：按住右摇杆（JOYR键）
3. 松开按键即停止旋转

### 组合动作
- 斜向移动：同时推动摇杆的前后和左右方向
  - 由于代码优先判断幅度较大的方向，小车会朝主导方向移动
  - 如需斜向移动，需要修改控制逻辑添加向量合成

## 🔍 调试技巧

### 检查手柄连接
```c
// 在main.c的while循环中查看
if(ps2_data.mode == 0x73 || ps2_data.mode == 0x41)
{
    // 手柄正常连接
    printf("Controller OK\r\n");
}
else
{
    // 手柄未连接
    printf("No Controller: 0x%02X\r\n", ps2_data.mode);
}
```

### 查看按键状态
```c
// 打印按键状态
printf("BTN1:0x%02X JOYL:%d JOYR:%d\r\n", 
       ps2_data.btn1,
       (ps2_data.btn1 & (1<<2)) ? 1 : 0,  // JOYL
       (ps2_data.btn1 & (1<<1)) ? 1 : 0); // JOYR
```

### 查看摇杆值
```c
printf("LJoy: LR=%d UD=%d\r\n", 
       ps2_data.LJoy_LR, 
       ps2_data.LJoy_UD);
```

## ⚠️ 注意事项

1. **按键优先级**
   - 按住JOYL或JOYR时，摇杆输入会被忽略
   - 确保在需要平移时没有误按摇杆

2. **死区设置**
   - 摇杆死区为127±15（即112~142为中点）
   - 如果小车自己乱动，可适当增大DEAD_ZONE值

3. **平移方向**
   - 左平移：左电机后退，右电机前进
   - 右平移：左电机前进，右电机后退
   - 如果方向反了，检查电机接线或调换宏定义中的SET/RESET

4. **旋转方向**
   - 原地左转：左电机后退，右电机前进
   - 原地右转：左电机前进，右电机后退
   - 如果旋转方向反了，交换Car_TurnLeft和Car_TurnRight的实现

5. **万向轮要求**
   - 必须使用麦克纳姆轮或全向轮才能实现平移
   - 普通轮子无法左右平移，只能原地旋转

## 🚀 进阶功能

### 斜向移动（需要修改代码）
在PS2_Control_Car函数中添加向量合成：

```c
// 计算合成速度
int16_t left_pwm = forward_speed - strafe_speed;
int16_t right_pwm = forward_speed + strafe_speed;

// 限幅
if(left_pwm > MAX_PWM) left_pwm = MAX_PWM;
if(left_pwm < -MAX_PWM) left_pwm = -MAX_PWM;
if(right_pwm > MAX_PWM) right_pwm = MAX_PWM;
if(right_pwm < -MAX_PWM) right_pwm = -MAX_PWM;

Car_Control(left_pwm, right_pwm);
```

### 可调旋转速度
使用右摇杆的上下控制旋转速度：

```c
if(btn1 & BTN_JOYL)
{
    int16_t turn_speed = Map_Joystick_To_PWM(ps2_data.RJoy_UD);
    if(turn_speed == 0) turn_speed = 400;  // 默认速度
    Car_TurnLeft(abs(turn_speed));
}
```

---

**版本**：v2.0（万向轮版本）  
**日期**：2025-10-27  
**作者**：PS2 Hybrid Car Control System
