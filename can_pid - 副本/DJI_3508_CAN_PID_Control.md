# DJI-3508电机CAN通信与PID速度控制使用说明

## 概述

本项目实现了通过CAN总线控制DJI-3508电机，并使用PID算法进行速度闭环控制的功能。该实现基于STM32F1系列微控制器和HAL库。

## 功能特性

1. **CAN通信控制**：通过CAN总线发送控制指令给DJI-3508电机
2. **PID速度控制**：实现速度闭环控制，精确控制电机转速
3. **多电机支持**：可同时控制多达4个DJI-3508电机
4. **反馈数据处理**：接收并解析电机反馈数据

## 硬件连接

- **CAN总线连接**：
  - PA11 (CAN_RX)
  - PA12 (CAN_TX)
  
- **终端电阻**：确保CAN总线上有120欧姆终端电阻

## 软件架构

### 主要文件

1. **can.h/can.c**：CAN通信相关函数实现
2. **main.c**：主程序，包含PID控制逻辑
3. **stm32f1xx_it.c**：中断处理程序

### 核心函数

#### 1. 电机控制函数

```c
// 控制单个电机
void can_dji_motor_control(uint8_t motor_id, int16_t current);

// 同时控制四个电机
void can_dji_motor_control_multi(int16_t current1, int16_t current2, int16_t current3, int16_t current4);
```

#### 2. PID控制函数

```c
// 初始化PID控制器
void pid_init(pid_controller_t *pid, float kp, float ki, float kd);

// PID计算
float pid_calculate(pid_controller_t *pid, float target, float current);
```

## 使用方法

### 1. 初始化

在[main.c](file:///c%3A/RM/can_pid/Core/Src/main.c)的初始化部分，已经完成了以下初始化：
- CAN总线初始化
- PID控制器初始化

### 2. 参数配置

在[main.c](file:///c%3A/RM/can_pid/Core/Src/main.c)中可以调整以下参数：

```c
// PID参数设置
pid_init(&motor_pid, 10.0f, 0.1f, 1.0f);  

// 目标速度设置
motor_pid.target = 1000.0f;  // 目标速度为1000 RPM
```

### 3. 控制流程

1. 系统每10ms执行一次PID计算
2. 获取电机实际速度（在实际应用中应从电机反馈数据中获取）
3. 使用PID算法计算输出电流
4. 通过CAN总线发送控制指令给电机

## CAN通信协议

### 控制指令帧

- **CAN ID**：0x200
- **数据长度**：8字节
- **数据格式**：
  - 字节0-1：电机1电流值（高字节在前）
  - 字节2-3：电机2电流值（高字节在前）
  - 字节4-5：电机3电流值（高字节在前）
  - 字节6-7：电机4电流值（高字节在前）

### 反馈数据帧

- **CAN ID**：0x201 ~ 0x204（对应电机1~4）
- **数据长度**：8字节
- **数据格式**：
  - 字节0-1：电机角度（高字节在前）
  - 字节2-3：电机转速（高字节在前）
  - 字节4-5：电机电流（高字节在前）
  - 字节6-7：电机温度（高字节在前）

## PID参数调节建议

1. **比例系数(Kp)**：决定系统响应速度，值越大响应越快但可能产生振荡
2. **积分系数(Ki)**：消除稳态误差，值过大会导致系统不稳定
3. **微分系数(Kd)**：抑制超调，提高系统稳定性

建议调节顺序：Kp → Kd → Ki

## 注意事项

1. 确保CAN总线物理连接正确且有终端电阻
2. 电机电流限制在±16384范围内
3. 实际应用中应从电机反馈数据中获取真实的速度值
4. 根据具体应用场景调整PID参数

## 故障排除

1. **电机不转动**：
   - 检查CAN总线连接
   - 确认电机电源正常
   - 检查控制电流值是否正确发送

2. **速度控制不准确**：
   - 检查PID参数设置
   - 确认反馈数据正确解析
   - 检查机械负载是否发生变化

3. **电机抖动或振荡**：
   - 降低PID参数，特别是Kp和Ki
   - 检查CAN通信是否稳定